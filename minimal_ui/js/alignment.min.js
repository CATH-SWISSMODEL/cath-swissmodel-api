(function(g){function C(c){return g("#alignNameTbl"+c.attr("id").substring(8))}function S(c){g(document).mouseup(function(){if(g.data(c,"downchain")){var d=g("#offscreen_selection span");if(window.getSelection&&0<d.length){var f=window.getSelection(),l=document.createRange();l.setStart(d.get(0),0);l.setEndAfter(d.get(-1),0);f.addRange(l)}else document.selection&&(document.body.createTextRange(),document.selection.empty());g.data(c,"downchain",null)}c.data("mouseDragEdit",null)});g(document).mousemove(function(){g.data(c,
"downchain")&&(window.getSelection?(windowSelection=window.getSelection(),windowSelection.removeAllRanges()):document.selection&&document.selection.empty())});c.off();if(null==c.data("options")||"textOnly"in c.data("options")&&!c.data("options").textOnly)var d=null;if(c.data("templateData")&&c.data("templateData").charts)c.on("mouseover mousedown mouseup mousemove dblclick","td",function(e){var f=g(this).find("span");if(0!=f.length){var l=f[0].getBoundingClientRect().width,k=g(this);if(e.pageX||e.pageY)var m=
e.pageX-k.offset().left;else if(e.clientX||e.clientY)m=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-k.offset().left;$span=g(f[Math.floor(m/l)]);d!=$span.text()?(d=$span.text(),ea(c,$span,"mouseover",e)):(d=$span.text(),ea(c,$span,e.type,e))}});c.on("mouseover mousedown mouseup mousemove dblclick","span",function(d){ea(c,g(this),d.type,d)})}function ea(c,d,e,f){var l=d.text();U&&Ba(d,f);if(l!=M.gapChar){var k=d.closest("tr");f=k.attr("chain");var m=null;f||(f=k.attr("keyseqtype"),
m=k.attr("keyseqchain"));var q=k.attr("struc_id");!q&&k.attr("tpl_id")&&(q=k.attr("tpl_id"));k=d.attr("s");var t=c.data("templateData");"mouseover"==e&&(d.attr("title")||null==O[l.toUpperCase()]||d.attr("title",O[l.toUpperCase()].triplet+" "+k+" "+(m?m:f)+(d.attr("q")?"; QMEAN: "+parseFloat(d.attr("q")).toFixed(2):"")),c.attr("title",d.attr("title")),"seqres-chain"==f||"target-template"==f||"model-template"==t.type&&null==m||g("body").trigger("highlightResidue",{src:"alignment",struc_id:q,chain:m?
m:f,resno:parseInt(k)}));if(!U&&t)if(l=!("target-template"==t.type&&"target-template"==f),"mousedown"==e)g.data(c,"downspan",d),g.data(c,"downchain",f+m+q),g(".selectResidue").removeClass("selectResidue");else if("mousemove"==e||"mouseup"==e)if(g.data(c,"downchain")&&(window.getSelection?(t=window.getSelection(),t.removeAllRanges(),B=document.createRange()):document.selection&&document.selection.empty()),"seqres-chain"==f||g.data(c,"downchain")!=f+m+q)g.data(c,"downchain");else if("mousemove"!=e||
null==g.data(c,"lastMouseDrag")||g.data(c,"lastMouseDrag")!=f+m+q+d.index()){g.data(c,"lastMouseDrag",f+m+q+d.index());t=c.find("tr["+(m?'keyseqchain="'+m+'"':q?'struc_id="'+q+'"':'chain="'+f+'"')+"]");var n=g.data(c,"downspan"),r=d,u=t.index(n.closest("tr")),v=t.index(r.closest("tr"));if("mouseup"==e&&n.index()==r.index()&&u==v)d.addClass("selectResidue"),l&&g("body").trigger("centerResRange",{src:"alignment",struc_id:q,chain:m?m:f,min:k,max:k});else{if(u>v||u==v&&n.index()>r.index())k=u,r=n,n=d,
u=v,v=k;if(n.index()!=r.index()||u!=v)g(".selectResidue").removeClass("selectResidue"),n.addClass("selectResidue"),r.addClass("selectResidue"),t.each(function(d){d<u||d>v||(d==u?n.nextUntil(r).addClass("selectResidue"):d==v?r.prevUntil(r).addClass("selectResidue"):g(this).find("span").addClass("selectResidue"))});l&&"mouseup"==e&&g("body").trigger("centerResRange",{src:"alignment",struc_id:q,chain:m?m:f,min:parseInt(n.attr("s")),max:parseInt(r.attr("s"))})}c=c.find(".selectResidue");if(0<c.length)if(g("#offscreen_selection").html(""),
c.clone().appendTo(g("#offscreen_selection")),window.getSelection){t=window.getSelection();var B=document.createRange();B.setStart(g("#offscreen_selection span").get(0),0);B.setEndAfter(g("#offscreen_selection span").get(-1),0);t.addRange(B)}else document.selection&&(document.body.createTextRange(),document.selection.empty())}}}function Ba(c,d){d.stopPropagation();d.preventDefault();if(!Z){var e=c.closest(".alignTbl"),f=c.closest("tr"),l=c.closest("tr").attr("seqno"),k=f.attr("chain");k||(k=f.attr("keyseqtype"),
f.attr("keyseqchain"));e.data("templateData");if("mouseover"!=d.type)if("dblclick"==d.type)c.hasClass("shadowCursor")&&(e.data("mouseDragEdit")||("-"==c.text()?la():ma()));else if("mousedown"==d.type){if(!c.hasClass("shadowCursor")){var m=g(".shadowCursor").first();if(d.shiftKey&&m)if(m.closest("tr").attr("seqno")==l){g(".shadowCursor").removeClass("shadowCursor");f=e.find("tr[seqno="+l+"]").find("span");k=f.index(m);l=f.index(c);if(k<l)e.data("startEditRegion",m),e.data("endEditRegion",c);else{var q=
k;k=l;l=q;e.data("startEditRegion",c);e.data("endEditRegion",m)}f.slice(k,l).each(function(){g(this).addClass("shadowCursor")});e.data("mouseDragEdit",!1)}else return;else g(".shadowCursor").removeClass("shadowCursor"),c.addClass("shadowCursor"),e.data("mouseDragEdit",!0),e.data("startEditRegion",c),e.data("endEditRegion",c)}g(".cursor").removeClass("cursor");c.addClass("cursor")}else"mousemove"==d.type?((m=window.getSelection?window.getSelection():document.selection)&&(m.removeAllRanges?m.removeAllRanges():
m.empty&&m.empty()),e.data("mouseDragEdit")&&(f=e.data("startEditRegion"),0!=f.length&&(e=0,e=d.pageX>f.offset().left?(d.pageX-f.offset().left)/f.outerWidth()|0:(d.pageX-f.offset().left-f.outerWidth())/f.outerWidth()|0,g(".shadowCursor").removeClass("shadowCursor"),0<e?f.nextAll(":lt("+e+")").addClass("shadowCursor"):0>e&&f.prevAll().slice(0,Math.abs(e)).each(function(){g(this).addClass("shadowCursor")}),f.addClass("shadowCursor")))):"mouseup"==d.type&&(f=e.data("startEditRegion"))&&(f=e.find("tr[seqno="+
l+"]").find("span"),k=f.index(m),K={seqno:l,seqidx:f.index(c)},e.data("startEditRegion",g("span.shadowCursor").first()),e.data("endEditRegion",g("span.shadowCursor").last()),e.data("mouseDragEdit",!1))}}function na(c,d){if(null==d||1>d.length)return!1;var e=g("body").data("editHistory");null==e&&(e=[]);e.push(d);g("body").data("editHistory",e);e=g(".alignTbl").not(c);0<e.length&&(fa(e,d,!1),g(".cursor").removeClass("cursor"));return!0}function fa(c,d,e,f){c.each(function(){if(null!=g(this).data("templateData")){for(var c=
g(this).data("templateData").templates,k=0;k<d.length;k++)for(var m=d[k],q=0;q<m.length;q++)for(var t=0;t<c.length;t++)if(c[t].id==m[q].template.id){e?(c[t].trg_seq=m[q].trg_seq,c[t].tpl_seq=m[q].tpl_seq):(c[t].trg_seq=m[q].template.trg_seq,c[t].tpl_seq=m[q].template.tpl_seq);f&&(K=m[q].currentCursor,k==d.length-1&&aa(c[t]));break}g(this).is(":visible")&&L(g(this),null,{firstDraw:!1})}})}function aa(c){if(!(1>g("#seqid_"+c.id).length)){for(var d=0,e=0,f=0;f<c.trg_seq.length;f++)"-"==c.trg_seq.charAt(f)||
"-"==c.tpl_seq.charAt(f)?d++:c.trg_seq.charAt(f)==c.tpl_seq.charAt(f)&&e++;g("#seqid_"+c.id).text((e/(c.trg_seq.length-d)*100).toFixed(2))}}function ha(c,d){null==c&&(38==d.keyCode?c="up":40==d.keyCode?c="down":37==d.keyCode?c="left":39==d.keyCode&&(c="right"));if(null!=c){d&&d.preventDefault();var e=g("span.cursor").first(),f=e.closest("tr");f.closest(".alignTbl");var l=f.attr("seqno"),k=e.index(),m=k,q=f.prevAll("[seqno="+l+"]");if(0<q.length){var t=q.find("span");m+=t.length}var n=l;if("up"==c&&
0<f.index()){var r=f.prev();n=r.attr("seqno");r=r.find("span:eq("+k+")")}else"down"==c&&0<f.next().length?(r=f.next(),n=r.attr("seqno"),r.find("span:eq(rowidx)"),r=f.next().find("span"),r=r.length>k?r.eq(k):r.last()):"left"==c?0==e.prev().length?0<q.length&&(r=t.last(),m--):(r=e.prev(),m--):"right"==c&&(0<e.next().length?(r=e.next(),m++):(f=f.nextAll("[seqno="+l+"]:eq(0)"),0<f.length&&(r=f.find("span").first(),m++)));null!=r&&(e.removeClass("cursor"),r.addClass("cursor"),K={seqno:n,seqidx:m})}}function ma(){var c=
[],d=g("span.cursor").first(),e=d.closest("tr"),f=e.attr("seqno"),l=e.closest(".alignTbl");if(!d.hasClass("shadowCursor"))if(0==l.find("span.shadowCursor").length)d.addClass("shadowCursor");else return c;if(null==l.data("templateData"))return c;var k=l.find("span.shadowCursor").last(),m=k.index(),q=k[0]==d[0],t=l.find("tr"),n=k.closest("tr"),r=g(),u=0;t.filter("[seqno="+f+"]").each(function(){u++;var d=g(this).find("span");if(g(this)[0]==n[0])return r=r.add(d.slice(0,m+1)),!1;r=r.add(d)});k=r.index(d);
var v=r.text(),B=l.data("templateData").templates;e=null!=e.attr("keyseqchain");for(var w,F,I=e?null:t.filter("[seqno=1]").slice(0,u),z=d.nextAll(".shadowCursor").addBack(),A=0;A<B.length;A++)if(!(null==B[A].selected||1>B[A].selected)){if(e)w=B[A].trg_seq,F=B[A].tpl_seq,I=t.filter("[seqno="+(B[A].selected+1)+"]").slice(0,u);else if(B[A].selected==f-1)w=B[A].tpl_seq,F=B[A].trg_seq;else continue;I.find("span").slice(0,v.length).text();for(var D="",E=!1,T=!1,H=0;H<v.length;H++)if(H<k)D+=w.charAt(D.length);
else if(E)if("-"==v.charAt(H)){D+=w.charAt(D.length-1);T=!0;break}else D+=w.charAt(D.length-1);else D+="-",E=!0;T?w=D+w.substring(D.length):E&&(w=D+w.substring(D.length-1),q||(F=F.substring(0,D.length-1)+"-"+F.substring(D.length-1)));w.length>F.length?F+=Array(w.length-F.length+1).join("-"):F.length>w.length&&(w+=Array(F.length-w.length+1).join("-"));D={template:B[A],trg_seq:B[A].trg_seq,tpl_seq:B[A].tpl_seq,currentCursor:{seqno:K.seqno,seqidx:K.seqidx}};e?(B[A].trg_seq=w,B[A].tpl_seq=F):(B[A].trg_seq=
F,B[A].tpl_seq=w);aa(B[A]);c[c.length]=D}1==z.length&&g(".shadowCursor").removeClass("shadowCursor");0<c.length?(ha("right"),l.data("templateData"),q&&(l.data("startEditRegion",null),l.data("endEditRegion",null)),na(l,[c])&&L(l,null,{firstDraw:!1})):oa(d,'<strong style="color:red">The pairwise alignment already contains a gap at this position</strong>')}function oa(c,d){Z=!0;c.removeAttr("title").popover({html:!0,content:d,placement:"top"}).popover("show");setTimeout(function(){c.popover("destroy");
Z=!1},2E3)}function la(c){var d=[],e=g("span.cursor").first(),f=e.closest("tr"),l=f.attr("seqno"),k=f.closest(".alignTbl"),m=2>k.find("span.shadowCursor").length;if(c){if("-"!=e.prev().text())return;m&&e.removeClass("shadowCursor");e=e.prev();e.addClass("shadowCursor")}else if("-"!=e.text())return;if(null==k.data("templateData"))return d;if(!e.hasClass("shadowCursor"))if(0==k.find("span.shadowCursor").length)e.addClass("shadowCursor");else return d;var q=k.find("span.shadowCursor").last(),t=q.index(),
n=k.find("tr"),r=q.closest("tr"),u=g(),v=0;n.filter("[seqno="+l+"]").each(function(){v++;var d=g(this).find("span");if(g(this)[0]==r[0])return u=u.add(d.slice(0,t+1)),!1;u=u.add(d)});q=u.index(e);var B=u.text(),w=k.data("templateData").templates;f=null!=f.attr("keyseqchain");var F="",I=f?null:n.filter("[seqno=1]").slice(0,v);e.nextAll(".shadowCursor").addBack();for(var z=0;z<w.length;z++)if(!(null==w[z].selected||1>w[z].selected)){if(f){var A=w[z].trg_seq;var D=w[z].tpl_seq;I=n.filter("[seqno="+(w[z].selected+
1)+"]").slice(0,v)}else if(w[z].selected==l-1)A=w[z].tpl_seq,D=w[z].trg_seq;else continue;F=I.find("span").slice(0,B.length).text();for(var E="",T=!1,H=0;H<B.length;H++)if(H!=q)if(H<q)E+=A.charAt(E.length);else if("-"==B.charAt(H)){if("-"!=F.charAt(H)){if(T)break;E+="-"}}else T=!0,E+=A.charAt(E.length+1);A=m?E+A.substring(E.length+1):E+"-"+A.substring(E.length+1);A.length>D.length?D+=Array(A.length-D.length+1).join("-"):D.length>A.length&&(A+=Array(D.length-A.length+1).join("-"));F={template:w[z],
trg_seq:w[z].trg_seq,tpl_seq:w[z].tpl_seq,currentCursor:{seqno:K.seqno,seqidx:K.seqidx}};f?(w[z].trg_seq=A,w[z].tpl_seq=D):(w[z].trg_seq=D,w[z].tpl_seq=A);aa(w[z]);d[d.length]=F}0<d.length?(c&&ha("left"),m&&(k.data("startEditRegion",null),k.data("endEditRegion",null)),na(k,[d])&&L(k,null,{firstDraw:!1})):oa(e,'<strong style="color:red">No valid gaps to be deleted in the selected range</strong>')}function Ca(c,d){var e=0,f=[],l=[],k=[],m="";g.each(c.templates,function(c,g){g&&(!d||g.selected)&&g.trg_seq&&
(l[l.length]=g,f[f.length]="",k[k.length]=0,e=Math.max(g.trg_seq.length,e))});l.sort(function(d,c){return d.selected<c.selected?-1:d.selected>c.selected?1:0});if(0!=l.length){var q=null;c.keyseq_sequence?q=c.keyseq_sequence:(q=l[0].trg_seq,c.templates[0].up_res_num||(q=q.replace(/-/g,"")));for(var t=0;t<e;){for(var n=0,r=0,u=0;u<l.length;u++){for(r=0;l[u].trg_seq.charAt(k[u]+r)==M.gapChar;)r++;n=Math.max(r,n)}for(r=0;r<n;)m+=M.gapChar,r++;m+=q.charAt(t++);for(u=0;u<l.length;u++)if(l[u].tpl_seq){for(r=
0;l[u].trg_seq.charAt(k[u])==M.gapChar;)f[u]+=l[u].tpl_seq.charAt(k[u]++),r++;for(;r<n;)f[u]+=M.gapChar,r++;f[u]+=l[u].tpl_seq.charAt(k[u]++)}}f.target=m;f.templates=l;aa(l[0]);return f}}function pa(c,d){var e;c.templates&&(e=Ca(c,!0));if(!e)if(e=[],e.templates=["empty"],c.keyseq_sequence)e.target=c.keyseq_sequence;else{for(var f=0;f<c.templates.length;f++)if(c.templates[f].trg_seq){e.target=c.templates[f].trg_seq.replace(/-/g,"");break}f=c.templates[f].trg_seq.length-e.target.length;1==c.templates.length&&
0<f&&g("#alignmentWarning_"+d.attr("id").substring(8)).html('<div class="alert alert-warning"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>Note: </strong> '+f+" gaps were removed from your target sequence</div>")}return e}function L(c,d,e){$alignNameTbl=C(c);c.removeData("clustalColours");var f=c.data().templateData;f||(f=g("#alignTbl").data().templateData);if(f){d||(d=pa(f,c));var l={cols:60,fastDraw:!1,textOnly:30<d.length,showResiduePosition:!0};c.data("options")?
e=g.extend(c.data("options"),e):(e||(e={}),!e.cols&&c.attr("cols_cookie")&&g.cookie(c.attr("cols_cookie"))&&(e.cols=g.cookie(c.attr("cols_cookie"))),e=g.extend(l,e));0==e.cols&&(e.cols=50);e.cols=parseInt(e.cols);var k=c.attr("id").substring(8);l=e.fastDraw;if(e.textOnly)g("#alignTbl"+k+"_features").remove(),c.off();else if(l){g("#alignTbl"+k+"_features").html("");var m=qa["timer"+k];m&&clearTimeout(m);e.fastDraw=!1;m=setTimeout(function(){L(c,d)},10);qa["timer"+k]=m}c.data("options",e);for(k=document.getElementById(c.attr("id"));k.hasChildNodes();)k.removeChild(k.lastChild);
for(k=document.getElementById($alignNameTbl.attr("id"));k&&k.hasChildNodes();)k.removeChild(k.lastChild);var q=f.target_name?f.target_name:"model-template"==f.type?f.struc_id:f.type.split("-")[0];q=q.charAt(0).toUpperCase()+q.substring(1);var t="SEQRES"==q.toUpperCase();m=k="";for(var n=0;n<d.target.length;n+=e.cols){for(var r=1,u=0;u<f.keyseq_chain_name.length;u++){var v=f.keyseq_chain_name[u];m+='<tr seqno="'+r+'" '+ra(f.keyseq_description)+"><td"+(0<n&&0==u||f.charts?' style="position:relative; padding-top:'+
(Q+P+10)+'px"':"")+">"+(0<Q?'<div style="position:absolute; right:4px; top:'+(Q+P)/2+'px ">QMEAN</div>':"")+q+(1<f.keyseq_chain_name.length?":"+v:"")+"</td></tr>";var B=d.templates[0].trg_offset?d.templates[0].trg_offset:1;k+='<tr seqno="'+r+'" keyseqtype="'+f.type+'"'+(f.struc_id?' struc_id="'+f.struc_id+'"':"")+' keyseqchain="'+v+'"><td'+(0<n&&0==u||f.charts?' style="padding-top:'+(Q+P+10)+'px"':"")+">"+(e.fastDraw?sa(d.target.substring(n,n+e.cols)):e.textOnly?"<span>"+d.target.substring(n,n+e.cols)+
"</span>":ia(d.target.substring(n,n+e.cols),{alIndex:n,pos:ja(d.target.substring(0,n)),offset:B,annotation:f.keyseq_annotation?f.keyseq_annotation[v]:null,seqres:t,up_res_num:f.templates&&f.templates[u]&&f.templates[u].up_res_num?f.templates[u].up_res_num.slice(n,n+e.cols):null}))+"</td></tr>";r+=1}for(u=0;u<d.length;u++)d.templates[u].tpl_seq&&(m+='<tr seqno="'+r+'" '+(null!=d.templates[u].id?'tpl_id="'+d.templates[u].id+'"':"")+' chain="'+d.templates[u].chain+'"'+ra(d.templates[u].description)+
'><td nowrap align="left" >'+d.templates[u].qname+"</td></tr>"),v=d.templates[u].offset?d.templates[u].offset+1:1,d.templates[u].tpl_seq&&(k+='<tr seqno="'+r+'" '+(null!=d.templates[u].id?'tpl_id="'+d.templates[u].id+'"':"")+("model-template"!=f.type&&d.templates[u].struc_id?' struc_id="'+d.templates[u].struc_id+'"':"")+' qname="'+d.templates[u].qname+'" chain="'+d.templates[u].chain+'"><td nowrap align="left" >'+(e.fastDraw?sa(d[u].substring(n,n+e.cols)):e.textOnly?"<span>"+d[u].substring(n,n+e.cols)+
"</span>":f.templates[u].pdb_res_num?ia(d[u].substring(n,n+e.cols),{alIndex:n,pos:ja(d[u].substring(0,n)),offset:v,seqres:t,annotation:d.templates[u].annotation,targetSeq:d.target.substring(n,n+e.cols),pdb_res_num:f.templates[u].pdb_res_num.slice(n,n+e.cols)}):ia(d[u].substring(n,n+e.cols),{alIndex:n,pos:ja(d[u].substring(0,n)),offset:v,seqres:t,annotation:d.templates[u].annotation,targetSeq:d.target.substring(n,n+e.cols)}))+"</td></tr>"),r+=1}(f=g.cookie("secStruct"))&&"none"==f||c.addClass("ss");
$alignNameTbl.last().append(m);c.last().append(k);var w;e.showResiduePosition&&c.find("tr").each(function(d,c){w=0<d&&1==c.getAttribute("seqno")?"padding-top:"+(Q+P)+"px":"";var e=g(this).find("span[s]").last().attr("s");e&&g(this).append('<td style="padding-left:8px; font-size:.8em; text-align:right; '+w+'">'+e+"</td>")});l||(e.default_colour?(g("#"+e.default_colour+"Button").prop("checked",!0),V(e.default_colour,c)):V(g.cookie("colourScheme"),c),d=null,e.firstDraw||W(c))}}function ja(c){return(c=
c.match(/[^-]/g))?c.length:0}function ra(c){return c?' title="'+c+'" ':""}function sa(c){for(var d="",e=0;e<c.length;e++)d+="<span>"+c.charAt(e)+"</span>";return d}function ia(c,d){var e=d.pos,f=d.alIndex,g=d.seqres,k=null!=d.targetSeq,m="";if(c)for(var q=0;q<c.length;q++)res=c.charAt(q),res==M.gapChar?m+='<span nm="true">-</span>':d.pdb_res_num?m+="<span "+ba(res.toUpperCase(),d.pdb_res_num[q],d.offset,d.annotation?d.annotation:null)+(k&&d.targetSeq.charAt(q)!=res?' nm="true"':"")+">"+res+"</span>":
d.up_res_num?m+="<span "+ba(res.toUpperCase(),d.up_res_num[q],d.offset,d.annotation?d.annotation:null,f+q)+(k&&d.targetSeq.charAt(q)!=res?' nm="true"':"")+">"+res+"</span>":g?m+="<span "+ba(res.toUpperCase(),f+q+d.offset,d.offset,d.annotation?d.annotation:null)+(k&&d.targetSeq.charAt(q)!=res?' nm="true"':"")+">"+res+"</span>":(m+="<span "+ba(res.toUpperCase(),e+d.offset,d.offset,d.annotation?d.annotation:null)+(k&&d.targetSeq.charAt(q)!=res?' nm="true"':"")+">"+res+"</span>",e++);return m}function ba(c,
d,e,f,g){if(g){if(f&&f.qmean&&null!=f.qmean[g])return's="'+d+'" r="'+c+'" q="'+f.qmean[g]+'" style="font-weight:bold" '}else if(f&&f.qmean&&null!=f.qmean[d-e])return's="'+d+'" r="'+c+'" q="'+f.qmean[d-e]+'" style="font-weight:bold" ';return's="'+d+'" r="'+c+'"'}function X(c,d,e){c[e][d]?c[e][d]++:c[e][d]=1}function Da(c){for(var d,e,f=[],g=0;g<c[0].length;g++){f[g]={};for(var k=d=0;k<c.length;k++)e=c[k].charAt(g).toUpperCase(),e==M.gapChar?d++:(X(f,e,g),"Q"!=e&&"E"!=e||X(f,"QE",g),"E"==e||"D"==e?
X(f,"ED",g):-1<"/[WLVIMAFCYHP]/".indexOf(e)?X(f,"WLVIMAFCYHP",g):"K"==e||"R"==e?X(f,"KR",g):("T"==e||"S"==e)&&X(f,"TS",g));f[g].gapCount=d;e={};for(var m in f[g])e[m+"_nogap"]=(f[g][m]/c.length).toFixed(2),f[g][m]=(f[g][m]/(c.length-d)).toFixed(2);for(m in e)f[g][m]=e[m]}return f}function V(c,d){var e=d.find("span").removeClass();if(0!=e.length){g.each(e,function(d,c){c.style.backgroundColor&&(c.style.backgroundColor="")});d.data("features")||(d.removeData("features"),d.data("currentColourScheme",
c));null==c&&(c="rainbow");if(d.data("features")){var f=d.data("features"),l="target-template"==d.data("templateData").type?"chain":"keyseqchain";d.find("tr["+l+"][struc_id="+f.struc_id+"]").each(function(){var d=g(this).attr(l);$span=g(this).find("span");for(var c=0;c<f.ranges.length;c++)if(f.ranges[c].frmChn!=f.ranges[c].toChn)if(-1<f.ranges[c].frmChn.indexOf(d)){var e="chain"==l?f.ranges[c].resStart:f.ranges[c].upStart;g.each($span.filter("[s="+e+"]"),function(d,e){e.style.backgroundColor="rgba("+
f.ranges[c].rgb+",.6)"})}else{if(-1<f.ranges[c].toChn.indexOf(d)){var k="chain"==l?f.ranges[c].resEnd:f.ranges[c].upEnd;g.each($span.filter("[s="+k+"]"),function(d,e){e.style.backgroundColor="rgba("+f.ranges[c].rgb+",.6)"})}}else-1!=f.ranges[c].frmChn.indexOf(d)&&(e="chain"==l?f.ranges[c].resStart:f.ranges[c].upStart,k="chain"==l?f.ranges[c].resEnd:f.ranges[c].upEnd,g.each($span.filter("[s]"),function(d,g){g.getAttribute("s")>=e&&g.getAttribute("s")<=k&&(g.style.backgroundColor="rgba("+f.ranges[c].rgb+
",.6)")}))})}else if("chain"==c||"uniqueChain"==c||"template"==c){var k="rgba(136,221,204,.6) rgba(255,255,187,.6) rgba(187,187,221,.6) rgba(255,136,119,.6) rgba(136,187,221,.6) rgba(255,187,102,.6) rgba(187,221,102,.6) rgba(255,204,238,.6) rgba(166,206,227,.6) rgba(187,136,187,.6) rgba(204,238,204,.6) rgba(166,206,227,.6)".split(" ");l=[];var m=null;if("undefined"!=typeof globalTemplateData){m=globalTemplateData;if(!globalTemplateData.chainColoursAssigned){for(var q=0,t=0,n=0;n<globalTemplateData.length;n++){var r=
globalTemplateData[n];r.chainColours={chain:[],unique:[],template:k[n%12]};for(var u=r.chain_name?"chain_name":"chain",v=0;v<r[u].length;v++){r.chainColours.unique[1<r[u][v].length?r[u][v].join(""):r[u][v]]=k[t];t++;t%=12;for(var B=0;B<r[u][v].length;B++)r.chainColours.chain[r[u][v][B]]=k[q],q++,q%=12}}globalTemplateData.chainColoursAssigned=!0}l=["struc_id","chain"]}else{m=d.data("templateData");l="model-template"==m.type?["struc_id","keyseqchain"]:["struc_id","chain"];var w="model-template"==m.type;
(m=m.templates)&&!m.chainColoursAssigned&&(t=q=0,g(".alignTbl").each(function(){if(g(this).data("templateData")&&g(this).data("templateData").templates){for(var d=w?g(this).data("templateData").keyseq_chain_name:null,c=g(this).data("templateData").templates,e=0;e<c.length;e++)if(c[e].chainColours={chain:[],unique:[]},d)for(var f=0;f<d.length;f++)c[e].chainColours.chain[d[f]]=k[q],c[e].chainColours.unique[d[f]]=k[t],q++,q%=12;else c[e].chainColours.chain[c[e].chain]=k[q],c[e].chainColours.unique[c[e].chain]=
k[t],q++,q%=12;t++;t%=12;c.chainColoursAssigned=!0}}))}m?(v=d.find("tr["+l[1]+"]"),g.each(v,function(d,e){var f=e.getAttribute(l[0]),k=e.getAttribute(l[1]);if(!k)return!1;for(var n=g(this).find("span"),q=null,r=0;r<m.length;r++)m[r].struc_id==f&&(q=m[r],n.each(function(d,e){if("chain"==c)e.style.backgroundColor=q.chainColours.chain[k];else if("template"==c)e.style.backgroundColor=q.chainColours.template;else for(chns in q.chainColours.unique)-1<chns.indexOf(k)&&(e.style.backgroundColor=q.chainColours.unique[chns])}))})):
d.find("span").each(function(c,e){e.style.backgroundColor=k[g(".alignTbl").index(d)%12]})}else if("rainbow"==c){var F=function(d,c){if(null!=c.getAttribute("s")){var e=d/I*(1.5*Math.PI-Math.PI/2)+Math.PI/2;c.style.backgroundColor="rgba("+Math.round(127.5*(Math.sin(e+Math.PI)+1))+","+Math.round(255*Math.sin(e-Math.PI/2))+","+Math.round(127.5*(Math.sin(e)+1))+",.6)"}},I=0,z=!1,A=0,D=d.find("tr");D.each(function(d,c){0==d&&(z="model-template"==c.getAttribute("keyseqtype"));if(parseInt(c.getAttribute("seqno"))<=
A)return!1;A=parseInt(c.getAttribute("seqno"));z&&null==c.getAttribute("keyseqtype")||($span=D.filter("[seqno="+A+"]").find("span"),I=$span.length,$span.each(F))})}else if("soa"==c||-1<c.indexOf("bvalue")||"entropy"==c)ta(d,c);else if("qmean_local"==c){var E,T,H;g.each(e.filter("[q]"),function(c,d){var e=parseFloat(d.getAttribute("q"));.5>e?d.style.backgroundColor="rgba(255,80,0,.6)":(e=(e-.5)/.4,E=Math.round(255*(1-e)),H=Math.round(255*e),d.style.backgroundColor="rgba("+E+",90,"+H+",.6)")})}else if("clustal"==
c){var G=d.data("clustalColours");G||(v=pa(d.data("templateData"),d),G=Da(v.concat(v.target)),d.data("clustalColours",G));var J,C=0;d.find("tr").each(function(){if(parseInt(g(this).attr("seqno"))<C)return!1;C=parseInt(g(this).attr("seqno"));g.each(d.find("tr[seqno="+C+"] span"),function(d,c){c.hasAttribute("r")&&((J=c.getAttribute("r"),"P"==J)?c.style.backgroundColor=Ea:"G"==J?c.style.backgroundColor=Fa:"H"!=J&&"Y"!=J||!(.6<=G[d].WLVIMAFCYHP||.5<G[d].P)?"D"==J&&(.5<=G[d].N||.5<=G[d].ED&&.5<=!G[d].QE)?
c.style.backgroundColor=ua:"E"==J&&(.5<=G[d].ED||.5<=G[d].QE)?c.style.backgroundColor=ua:"C"==J&&.85<=G[d].C?c.style.backgroundColor=Ha:"N"==J&&(.5<=G[d].N||.85<=G[d].D)?c.style.backgroundColor=ca:"Q"==J&&(.6<=G[d].KR||.5<=G[d].QE)?c.style.backgroundColor=ca:"S"==J&&(.5<=G[d].TS||.8<=G[d].WLVIMAFCYHP)?c.style.backgroundColor=ca:"T"==J&&(.5<=G[d].TS||.6<=G[d].WLVIMAFCYHP)?c.style.backgroundColor=ca:"R"!=J&&"K"!=J||!(.6<=G[d].KR||.85<=G[d].Q)?-1<"/[WLVIMAF]/".indexOf(J)&&(.5<=G[d].P||.6<=G[d].WLVIMAFCYHP)?
c.style.backgroundColor=va:"A"!=J&&"C"!=J||!(.5<=G[d].P||.6<=G[d].WLVIMAFCYHP||.85<=G[d].S)||(c.style.backgroundColor=va):c.style.backgroundColor=Ia:c.style.backgroundColor=Ga)})})}else if("secstruc"==c){r=g.cookie("secStruct");if(null==r||"none"==r)r="dssp";m=d.data("templateData");u=d.find("tr");if(m.keyseq_annotation){var N=m.templates[0].trg_offset?m.templates[0].trg_offset:1;for(n=0;n<m.keyseq_chain_name.length;n++)if(v=m.keyseq_chain_name[n],m.keyseq_annotation[v]&&m.keyseq_annotation[v][r]){annot=
wa(m.keyseq_annotation[v],r).replace(/[GI]/g,"H").replace(/B/g,"E");if(!annot)break;$row=u.filter('[keyseqchain="'+v+'"]');B=u.filter('[keyseqchain="'+v+'"]').find("span[s]").toArray();g.each(B,function(d,c){L=parseInt(c.getAttribute("s"));"E"==annot[L-N]?c.style.backgroundColor="rgba(51,204,51,.6)":"H"==annot[L-N]&&(c.style.backgroundColor="rgba(153,153,230,.6)")})}}C=0;for(E=1;E<u.length;E++){v=u.eq(E);if(parseInt(v.attr("seqno"))<C)break;C=parseInt(v.attr("seqno"));if(!v.attr("keyseqtype")){n=
v.attr("tpl_id");var P=v.attr("chain");$row=n?u.filter('[tpl_id="'+n+'"]'):u.filter('[chain="'+P+'"]');B=$row.find("span[s]").toArray();for(v=0;v<m.templates.length;v++)if((n?m.templates[v].id==n:m.templates[v].chain==P)&&m.templates[v].annotation&&m.templates[v].annotation[r]){annot=wa(m.templates[v].annotation,r);var L=0;g.each(B,function(d,c){L=parseInt(c.getAttribute("s"));"E"==annot[L-1]?c.style.backgroundColor="rgba(51,204,51,.6)":"H"==annot[L-1]&&(c.style.backgroundColor="rgba(153,153,230,.6)")})}}}}else if("hydrophobic"==
c){var M;g.each(e,function(d,c){(J=c.getAttribute("r"))&&O[J]&&(M=O[J].hydropathy,E=Math.round(255*M),H=255-Math.round(255*M),c.style.backgroundColor="rgba("+E+",0,"+H+",.6)")})}else if("size"==c)g.each(e,function(d,c){(J=c.getAttribute("r"))&&O[J]&&(M=O[J].mw,E=Math.round(255*M),T=255-Math.round(255*M),c.style.backgroundColor="rgba("+E+","+T+",0,.6)")});else if("charged"==c){var Q=O.positive;g.each(e,function(d,c){-1<O.positive.indexOf(c.getAttribute("r"))?c.style.backgroundColor="rgba(100,100,255,.6)":
-1<O.negative.indexOf(c.getAttribute("r"))&&(c.style.backgroundColor="rgba(255,100,100,.6)")})}else if("cysteine"==c)Q=O.positive,g.each(e,function(c,d){"C"==d.getAttribute("r")&&(d.style.backgroundColor="rgba(202,168,14,.6)")});else if("indels"==c){m=d.data("templateData");if("model-template"!=m.type)return;v=d.find("tr[chain]").find("span");for(n=0;n<m.keyseq_chain_name.length;n++){var R=d.find('tr[keyseqchain="'+m.keyseq_chain_name[n]+'"]').find("span"),S=R.length;R.each(function(c,d){"-"==d.textContent&&
(0<c&&"-"!=R.get(c-1).textContent&&(R.get(c-1).style.backgroundColor="rgba(0,0,255,.6)"),c<S-2&&"-"!=R.get(c+1).textContent&&(R.get(c+1).style.backgroundColor="rgba(0,0,255,.6)"))});v.each(function(c,d){"-"==d.textContent&&"-"!=R.get(c).textContent&&null!=R.get(c).q&&(R.get(c).style.backgroundColor="rgba(0,255,0,.6)")})}}else c&&"none"!=c&&(Q=O[c])&&g.each(e,function(d,e){-1<Q.indexOf(e.getAttribute("r"))&&g(e).addClass(c)});g.cookie("targetMismatch")&&"true"!=g.cookie("targetMismatch")||e.filter("[nm]").addClass("nonVisible");
U&&(K&&d.find("tr[seqno="+K.seqno+"]").find("span").eq(K.seqidx).addClass("cursor"),d.data("startEditRegion")&&d.data("endEditRegion")&&(e=d.data("startEditRegion"),v=d.data("endEditRegion"),n=e.closest("tr"),C=n.attr("seqno"),n=n.siblings("[seqno="+C+"]").addBack().find("span"),r=d.find("tr[seqno="+C+"]").find("span"),r=r.slice(n.index(e),n.index(v)+1).addClass("shadowCursor"),d.data("startEditRegion",r.first()),d.data("endEditRegion",r.last())))}}function ta(c,d){if("undefined"!=typeof SCORE_URL){var e=
c.data("templateData").templates;if(e){for(var f=0;f<e.length;f++){var l=e[f].pdb_id;l&&4!=l.length||(l=e[f].qname.match(/\w{4}\.\d+/)[0]);l in N||(N[l]={});if(e[f].selected&&!(d in N[l])){g.getJSON(SCORE_URL.replace("xxxx.0",l)+d,function(e,f){f&&(N[l][d]=e,ta(c,d))});return}}c.find("tr[chain]").each(function(){var c=g(this).attr("chain"),e=g(this).attr("qname").match(/\w+\.\d+/)[0];if(null==N[e][d][c])for(var f in N[e][d])for(var l=0;l<f.length;l++)f[l]==c&&(N[e][d][f[l]]=N[e][d][f]);var n=null;
g(this).find("span[s]").each(function(f,k){n=k.getAttribute("s");null!=N[e][d][c].values[n-1]&&(k.title=O[g(this).text()].triplet+" : "+n+"; "+d+" : "+N[e][d][c].values[n-1].toFixed(2));k.style.backgroundColor="rgba("+N[e][d][c].colours[n-1]+",.6)"})});g(".alignTbl").last().attr("id")==c.attr("id")&&da()}}}function da(){0<g("#pv:visible",currentWin.document).length&&Ja();0<g("#ngl:visible",currentWin.document).length&&Ka();if("function"===typeof colourUPArcs||"function"===typeof colourRama){var c=
{};g(".alignTbl").each(function(){$alignTbl=g(this);var d=$alignTbl.data("templateData");if(d&&!$alignTbl.data("options").textOnly){var e=-1,f=$alignTbl.find("tr[seqno=1]").find("span");for($rows="model-template"==d.type?$alignTbl.find("tr[keyseqchain]"):$alignTbl.find("tr[chain]");;){e++;d=$rows.filter("[seqno="+e+"]");if(1>d.length)if(1<e)break;else continue;var l=d.attr("chain");l||(l=d.attr("keyseqchain"));var k=d.attr("struc_id"),m=[];d.find("span").each(function(c,d){var e=g(d).css("background-color");
e&&"transparent"!=e&&-1==e.indexOf("(0, 0, 0")&&(e=e.match(/\d+, \d+, \d+/)[0].split(","),m[f[c].getAttribute("s")]=e)});c[k]||(c[k]={});c[k][l]=m}}});"function"===typeof colourRama&&colourRama(c);"function"===typeof colourUPArcs&&colourUPArcs(c)}}function Ka(){var c=null,d,e={};g(".alignTbl:not(.ignoreStructure)").each(function(){d=g(this);var f=d.data("templateData");if(f&&!d.data("options").textOnly){var l=-1;for(c="model-template"==f.type?d.find("tr[keyseqchain]"):d.find("tr[chain]");;){l++;var q=
c.filter("[seqno="+l+"]");if(1>q.length)if(1<l)break;else continue;(f=q.attr("chain"))||(f=q.attr("keyseqchain"));var t=q.attr("struc_id");q=q.find("span");var n=null;n=e[t]&&e[t][f]?e[t][f]:[];q.each(function(c,d){var e=g(d).css("background-color");e&&"transparent"!=e&&-1==e.indexOf("(0, 0, 0")&&(e=e.match(/\d+, \d+, \d+/)[0].split(","),n[d.getAttribute("s")]=e)});e[t]||(e[t]={});e[t][f]=n}}});for(var f in e)for(var l in ngl_stage.compList)ngl_stage.eachRepresentation(function(c){if(c.name==f||c.name.endsWith(".highlight")){var d=
e[f];for(g in NGL.ColormakerRegistry.userSchemes)-1<g.indexOf(f)&&NGL.ColormakerRegistry.removeScheme(g);var g=NGL.ColormakerRegistry.addScheme(function(c){this.atomColor=function(c){return d[c.chainname]?ngl_picked_atom&&c.structure.name==ngl_picked_atom.structure.name&&c.index==ngl_picked_atom.index?16711680:(c=d[c.chainname][c.resno])?c[0]<<16|c[1]<<8|c[2]:16777215:16777215}},f);c.setColor(g)}})}function Ja(){if(0!=pv_viewer.all().length){var c=null,d,e={};g(".alignTbl:not(.ignoreStructure)").each(function(){d=
g(this);var f=d.data("templateData");if(f&&!d.data("options").textOnly){var l=-1;for(c="model-template"==f.type?d.find("tr[keyseqchain]"):d.find("tr[chain]");;){l++;var q=c.filter("[seqno="+l+"]");if(1>q.length)if(1<l)break;else continue;(f=q.attr("chain"))||(f=q.attr("keyseqchain"));var t=q.attr("struc_id");q=q.find("span");var n=null;n=e[t]&&e[t][f]?e[t][f]:[];q.each(function(c,d){var e=g(d).css("background-color");e&&"transparent"!=e&&-1==e.indexOf("(0, 0, 0")&&(e=e.match(/\d+, \d+, \d+/)[0].split(","),
n[d.getAttribute("s")]=e)});e[t]||(e[t]={});e[t][f]=n}}});for(var f in e){var l=e[f];pv_viewer.get(f)&&pv_viewer.get(f).colorBy(new pv.color.ColorOp(function(c,d,e){c=c.residue();l[c.chain().name()]&&((c=l[c.chain().name()][c.num()])?(d[e]=c[0]/255,d[e+1]=c[1]/255,d[e+2]=c[2]/255):(d[e]=.9,d[e+1]=.9,d[e+2]=.9),d[e+3]=1)}))}f&&pv_viewer.requestRedraw()}}function W(c){var d=g.cookie("secStruct");null==d&&(d="dssp");var e=c.attr("id")+"_features";g("#"+e).html("");if(0==g("#"+e).length||d&&"none"==d)c.removeClass("ss"),
C(c).removeClass("ss");else{c.addClass("ss");C(c).addClass("ss");var f=c.position().top,l=c.find("td").first().width(),k=c.find("span")[0],m=k.getBoundingClientRect().width;k=k.getBoundingClientRect().height;var q=c.position().left;if(!(1>l)){p=Raphael(e,l,c.height());g("#"+e).css("top",c.position().top);var t=c.data("templateData");if(t){c=c.find("tr:visible");if(t.keyseq_annotation)for(e=0;e<t.keyseq_chain_name.length;e++){var n=t.keyseq_chain_name[e];if(t.keyseq_annotation[n]){var r=t.templates[0].trg_offset?
t.templates[0].trg_offset:1;t.keyseq_annotation[n][d]&&xa(p,ya(t.keyseq_annotation[n],d,r),c.filter('[keyseqchain="'+n+'"]'),c.filter('[keyseqchain="'+n+'"]').find("span[s]").toArray(),f,q,l,m,k);t.charts&&function(c,e,g){setTimeout(function(){La(c,t.keyseq_annotation[e],d,r,g,f,l,m)},0)}(p,n,c.filter('[keyseqchain="'+n+'"]'))}}e=0;for(n=1;n<c.length;n++){var u=c.eq(n);if(parseInt(u.attr("seqno"))<e)break;e=parseInt(u.attr("seqno"));if(!u.attr("keyseqtype")){var v=u.attr("tpl_id");u=u.attr("chain");
$row=v?c.filter('[tpl_id="'+v+'"]'):c.filter('[chain="'+u+'"]');for(var B=$row.find("span[s]").toArray(),w=0;w<t.templates.length;w++)(v?t.templates[w].id==v:t.templates[w].chain==u)&&t.templates[w].annotation&&t.templates[w].annotation[d]&&xa(p,ya(t.templates[w].annotation,d),$row,B,f,q,l,m,k)}}}}}}function wa(c,d){var e=c[d];"string"==typeof e&&(c[d+"_string"]=e.replace(/[GI]/g,"H").replace(/B/g,"E"));return c[d+"_string"]}function ya(c,d,e){e||(e=1);var f=c[d];if("string"==typeof f){c[d+"_string"]=
c[d];f=c[d].replace(/[GI]/g,"H").replace(/B/g,"E");for(var g=null,k=0;k<f.length;k++)if("H"==f[k]||"E"==f[k])res_index=k+e,null==g?g=[[res_index,res_index,f[k]]]:g[g.length-1][1]==res_index-1&&g[g.length-1][2]==f[k]?g[g.length-1][1]=res_index:g.push([res_index,res_index,f[k]]);c[d]=g}return c[d]}function La(c,d,e,f,l,k,m,q){var t=null!=d.qmean;f||(f=1);var n=c.set(),r=c.set();l.each(function(l,v){span=g(v).find("span[s]").toArray();if(0!=span.length){var u=v.getBoundingClientRect().left,w=g(span[0]).position().top-
k-P,F=Q-P;y=w;if(t){c.path("M0,"+y+"L"+m+","+y+"L"+m+","+(y-F)+"L0,"+(y-F)).attr({"stroke-width":.4,stroke:"#888"});for(var I=3;10>I;I++){var z=y-1/.7*F*(I/10-.3);var A=c.path("M0,"+z+"L"+m+","+z);5==I?A.attr({"stroke-width":.7,opacity:.8,stroke:"#888","stroke-dasharray":"-"}):n.push(A)}}for(I=0;I<span.length;I++)A=span[I],x=A.getBoundingClientRect().left-u,y=w,z=A.getAttribute("s"),d[e+"_string"]&&d[e+"_string"][parseInt(z)-f]&&(z=d[e+"_string"][parseInt(z)-f],"-"!=z&&r.push(c.text(x+q/2,y+P/2,z))),
y-=2,t&&(z=Math.max(.3,parseFloat(A.getAttribute("q"))),A="245,80,0",.5<z&&(l=Math.round(490*(1-z)),b=Math.round(255*z),A=l+",80,"+b),z=y-1/.7*(F-2)*(z-.3),z=c.path("M"+x+","+y+"L"+x+","+z+"L"+(x+q)+","+z+"L"+(x+q)+","+y),z.attr({fill:"rgba("+A+",.6)",stroke:"#333"}))}});r.attr({"text-anchor":"center"});n.attr({"stroke-width":.9,stroke:"#888",opacity:.6,"stroke-dasharray":". "})}function xa(c,d,e,f,l,k,m,q,t){if(null!=d){var n;e.attr("seqno");for(var r=0,u=f.length,v=0;v<d.length;v++)if("E"==d[v][2]||
"H"==d[v][2]){var B=null,w=null;for(n=d[v][0];n<=d[v][1];n++)if(!(f[r].getAttribute("s")>n)){for(s=r;s<u;s++)if(f[s].getAttribute("s")==n){r=s;B=g(f[s]);break}if(B)break}for(n=d[v][1];n>=d[v][0];n--){for(s=r;s<u;s++)if(f[s].getAttribute("s")==n){r=s;w=g(f[s]);break}if(w)break}if(null==B||null==w)r=0;else{var F=B.position().top-l;n=e.index(B.closest("tr"));var I=e.index(w.closest("tr"));for(var z=n;z<I+1;z++)if("E"==d[v][2]){var A=c,D=n==I?F:e.eq(z).find("span").first().position().top-l,E=B.position().left-
k-(z-n)*m,C=w.position().left-k+q+(I-z)*m,H=t;D+=1;H-=2;padding=2;E=Math.round(E);C=Math.round(C);s=A.path("M"+E+","+(D-padding)+"L"+(C-6)+","+(1.5+D)+"L"+(C-6)+","+(D-padding)+"L"+(C+padding)+","+(H/2+D)+"L"+(C-6)+","+(H+D+padding)+"L"+(C-6)+","+(H-1.5+D)+"L"+E+","+(H+D+padding)+"L"+E+","+(D-padding));s.attr({"stroke-width":.7,fill:"#DDD","fill-opacity":.3,stroke:"#226","stroke-dasharray":"5 2"})}else A=c,D=n==I?F:e.eq(z).find("span").first().position().top-l,E=B.position().left-k-(z-n)*m,C=w.position().left-
k+q+(I-z)*m,H=t,padding=2,E=Math.round(E),C=Math.round(C),h=A.rect(E,D+2-padding,C-E,H-4+2*padding,4),h.attr({"stroke-width":.7,fill:"#DDD","fill-opacity":.3,stroke:"#226"})}}}}function za(){var c="";"Multi FASTA"==g("#alignmentFormatSelect").val()?g(".alignTbl:visible").each(function(){c+=ka(g(this).attr("id").substring(8),"FASTA");c+="\n"}):c=ka(g("#currentAlignmentIndex").val(),g("#alignmentFormatSelect").val());g("#formattedAlignmentTextarea").val(c);g("#formattedAlignmentTextarea").focus();g("#formattedAlignmentTextarea").select()}
function ka(c,d){d||(d="fasta");var e=g("#alignNameTbl"+c),f=g("#alignTbl"+c),l=[],k=[],m=[],q=0<g("#alignTbl"+c+" :visible").first().length?":visible":"",t=0;e.find("tr"+q).each(function(c,d){parseInt(d.getAttribute("seqno"))>t&&t++}).slice(0,t).each(function(c){var d=g(this).attr("seqno");l[c]=g(this).text();m[c]=g(this).attr("title");f.find('tr[seqno="'+d+'"]').each(function(d){k[c]||(k[c]="");k[c]+=g(this).find("td").first().text()})});return-1<d.search(/fasta/i)?Ma(l,k,m):-1<d.search(/clustal/i)?
Na(l,k):""}function Ma(c,d,e){if(!d||0==d.length)return"No templates selected";for(var f="",g=0;g<c.length;g++){f+=">"+c[g]+(e&&e[g]?" "+e[g]:"")+"\n";for(var k=0;k<d[g].length;k+=72)f+=d[g].substring(k,k+72)+"\n"}return f}function Na(c,d){if(!d||0==d.length)return"No templates selected";for(var e=0,f=0;f<c.length;f++)e=Math.max(e,c[f].length);e+=2;for(var g="CLUSTAL\n\n",k=0;k<d[0].length;k+=60){for(f=0;f<c.length;f++){g+=c[f];for(var m=c[f].length;m<e;m++)g+=" ";g+=d[f].substring(k,k+60)+"\n"}g+=
"\n"}return g=g.substring(0,g.length-2)}function Oa(c){$alignNameTbl=C(c);var d=c.closest(".alignTblContainer").outerWidth(),e=c.closest(".alignTblContainer").outerHeight();d+=10;var f='<svg xmlns="http://www.w3.org/2000/svg"  width="'+d+'" height="'+e+'"><rect x="0" y="0" fill="white" width="'+d+'" height="'+e+'"/>',l,k=$alignNameTbl.outerWidth()+10,m=$alignNameTbl.offset().left-10,q=c.find("td:eq(0)");d=q.outerWidth();var t=g("<div>").append(g("#"+c.attr("id")+"_features svg").first().clone()).html().replace(/name="[\d_]+" /g,
"").replace(/r="4" /g,"");f+='<defs><clipPath id="cp2"><rect x="0" y="0" width="'+d+'" height="'+e+'"/></clipPath></defs>';f+='<g transform="translate('+k+',0)" clip-path="url(#cp2)">';f+=t.substring(t.indexOf("</defs>")+7,t.indexOf("</svg>"));f+="</g>";e=c.find("tr:visible");e.each(function(c,d){g(this).find("span.hoverResidue").each(function(c,e){l=d.offsetTop+e.offsetTop;n||(n=g(e).outerWidth(),r=g(e).outerHeight());g(e).css("color");f+='<rect style="fill:#CC4444;fill-opacity:0.8;" width="'+n+
'" height="'+r+'" x="'+(g(e).offset().left-m)+'" y="'+l+'" />'})});f+='<text text-anchor="end" font-size="'+q.css("font-size")+"\" font-family='"+q.css("font-family")+"'>";e=$alignNameTbl.find("tr:visible");e.each(function(c,d){var e=g(this).find("td").css("padding-top");e=parseInt(e.substring(0,e.length-2));l=d.offsetTop+12+e;f+='<tspan x="'+k+'" y="'+l+'">'+d.textContent+" </tspan>"});f+="</text>";e=c.find("tr:visible");var n,r;e.offset();e.each(function(c,d){f+='<text text-anchor="middle" font-size="'+
q.css("font-size")+"\" font-family='"+q.css("font-family")+"'>";g(this).find("span").each(function(c,e){n||(n=g(e).outerWidth(),r=g(e).outerHeight());var k=g(e).css("color");k="fill:"+k+";";"bold"==e.style.fontWeight&&(k+="font-weight:bold;");0<k.length&&(k=' style="'+k+'" ');l=d.offsetTop+e.offsetTop+12;f+='<tspan x="'+(g(e).offset().left-m+n/2)+'" y="'+l+'"'+k+">"+e.textContent+"</tspan>"});f+="</text>";(td=g(this).find("td")[1])&&(f+='<text text-anchor="start" font-size="'+q.css("font-size")+"\" font-family='"+
q.css("font-family")+"'><tspan x=\""+(g(td).offset().left-m+10)+'" y="'+l+'">'+td.textContent+"</tspan></text>")});e.each(function(c,d){g(this).find("span").not(".hoverResidue").each(function(c,e){l=d.offsetTop+e.offsetTop;var k=g(e).css("backgroundColor");k&&"transparent"!=k&&"rgb(255, 255, 255)"!=k&&(f+='<rect x="'+(g(e).offset().left-m)+'" y="'+l+'" width="'+n+'" height="'+r+'" style="fill:'+k+';"/>')})});return f+"</svg>"}var N={},M={gapChar:"-"},Aa=!1,U=!1,K=null,Q=0,P=0,Z=!1,Y={init:function(c){Aa||
(Aa=!0,g(document).keydown(function(c){if(U&&1>g(".fancybox-desktop:visible").length)a:if(Z)c.preventDefault();else{var d=g("span.cursor").closest(".alignTbl");if(32==c.keyCode)c.preventDefault(),ma();else if(8==c.keyCode||46==c.keyCode)c.preventDefault(),la(8==c.keyCode);else if(27==c.keyCode){d.data("startEditRegion",null);d.data("endEditRegion",null);g(".shadowCursor").removeClass("shadowCursor");break a}else if((c.ctrlKey||c.metaKey)&&90==c.keyCode){c=g("body").data("editHistory");if(!(null==
c||1>c.length)){c=c.pop();fa(d,c,!0,!0);var f=g(".alignTbl").not(d);0<f.length&&(fa(f,c,!0,!1),g(".cursor").removeClass("cursor"),d.find("tr[seqno="+K.seqno+"]").find("span").eq(K.seqidx).addClass("cursor"))}break a}ha(null,c)}else 27==c.keyCode&&g(".selectResidue").removeClass("selectResidue")}));return this.each(function(){var d=g.extend({},{type:"target-template",chaingroups:[],keyseq_sequence:c.keyseq_sequence,keyseq_chain_name:c.keyseq_chain_name?c.keyseq_chain_name:["A"],keyseq_annotation:c.keyseq_annotation},
c.templateData);if(c.charts&&c.keyseq_annotation){d.charts=c.charts;for(key in c.keyseq_annotation)break;c.keyseq_annotation[key].qmean&&(Q=48);P=12}c.firstDraw=!0;g(this).data("templateData",d);L(g(this),null,c);Y.toggleIdenticalSeqs.call(this,{chaingroups:d.chaingroups},!1);Y.resizeToParent.call(g(this),{redrawAnnotation:!1});W(g(this));S(g(this))})},toggleIdenticalSeqs:function(c,d){return g(this).each(function(){for(var e=g(this),f=C(e),l=0;l<c.chaingroups.length;l++){var k=c.chaingroups[l].filter(function(){return!0});
if(!(2>k.length)){var m=k[0],q=f.find('tr[chain="'+m+'"]').first().text(),t=q.substring(0,q.lastIndexOf(".")+1)+"("+k.join("")+")";q=q.substring(0,q.lastIndexOf("."))+"."+m.charAt(0);for(var n="",r=1;r<k.length;r++)n+="[chain="+k[r]+"]",r<k.length-1&&(n+=",");e.find("tr"+n).toggle();f.find("tr"+n).toggle();"none"==f.find("tr[chain="+k[1]+"]").css("display")?f.find("tr[chain="+m+"]").find("td").html(t):f.find("tr[chain="+m+"]").find("td").html(q)}}("undefined"==typeof d||d)&&W(e)})},drawAlignment:function(c){return this.each(function(){L(g(this),
c?c.seqs:null,c?c:null);S(g(this))})},getFormattedAlignment:function(c){return ka(g(this).attr("id").substring(8),c.format)},exportAlignment:function(c){return this.each(function(){g("#currentAlignmentIndex").val(g(this).attr("id").substring(8));g("#formattedAlignment").show();g("#alignmentFormatSelect").val(c.format);za();g("<a href='#formattedAlignment' title='Copy & Paste Alignment'/>'").fancybox({helpers:{title:{type:"inside"}}}).trigger("click");g("#formattedAlignmentTextarea").focus();g("#formattedAlignmentTextarea").select()})},
html2image:function(c){g.fancybox.close();g(".popover").hide();c=g("#currentAlignmentIndex").val();$alTbl=g("#alignTbl"+c);c=Oa($alTbl);c=new Blob([c],{type:"image/svg+xml;charset=utf-8"});c=(window.URL||window.webkitURL||window).createObjectURL(c);g("body").after('<canvas style="display:none" id="tmpcanvas"></canvas>');canvg("tmpcanvas",c,{renderCallback:function(){var c=document.getElementById("tmpcanvas");c.toBlob(function(c){saveAs(c,"alignment.png")});c.parentNode.removeChild(c)}})},colourAlignment:function(c){"undefined"===
typeof currentWin&&(currentWin=window);if(c.features)g(".alignTbl").each(function(){0<g(this).find("tr[struc_id="+c.features.struc_id+"]").length&&(g(this).data("features",c.features),V("features",g(this)))});else{jQuery.cookie("colourScheme",c.col,{expires:365,path:"/"});var d=g(".alignTbl").each(function(){g(this).removeData("features");null!=g(this).data().options&&delete g(this).data().options.default_colour;V(c.col,g(this))})}da();return d},changeExportFormat:function(c){return this.each(function(){za()})},
secondaryStructure:function(c){c&&jQuery.cookie("secStruct",c.sstype,{expires:365,path:"/"});var d=null;d=c?c.sstype:g.cookie("secStruct");null==d&&(d="dssp");P="none"==d?0:12;c=this.each(function(){g(this).data("templateData")&&(W(g(this)),"secstruc"==g(this).data("currentColourScheme")&&V("secstruc",g(this)))});var e=null,f=null;e=null;"undefined"!=typeof globalTemplateData?(g("#alignTbl"),"undefined"!=typeof globalTemplateData&&(f=globalTemplateData)):g(this).data("templateData")&&("model-template"==
g(this).data("templateData").type?e=!0:f=g(this).data("templateData").templates);if(0<g("#pv:visible",currentWin.document).length)if(e)this.each(function(){var c=g(this).data("templateData");if(c){var e=c.struc_id;if(pv_viewer.get(e)){var f=pv_viewer.get(e).structure();pv_viewer.rm(e);var k="none"==d;if(!k)for(var l=0;l<c.keyseq_chain_name.length;l++){var m=c.keyseq_chain_name[l],n=c.templates[0].trg_offset;n||(n=1);var q=c.keyseq_annotation[m][d+"_string"];m=f.select({chain:m});q?m.eachResidue(function(c){c.full().setSS(q[c.num()-
n])}):k=!0}k&&f.select("protein").eachResidue(function(c){c.full().setSS("")});pv_viewer.cartoon(e,f,{color:pv.color.uniform("white")})}}});else for(var l=0;l<f.length;l++){if(f[l].selected){var k=f[l].struc_id;e=pv_viewer.get(k).structure();pv_viewer.rm(k);if("none"==d)e.select("protein").eachResidue(function(c){c.full().setSS("")});else if(f[l].targets)for(var m=0;m<f[l].targets.length;m++)for(var q=f[l].targets[m],t=0;t<q.chain.length;t++)(n=q.annotation[q.chain[t]][d+"_string"])||(n=q.annotation[q.chain[t]][d]),
e.select({chain:q.chain[t]}).eachResidue(function(c){c.full().setSS(n[c.num()-1])});else{var n=f[l].annotation[d+"_string"];n||(n=f[l].annotation[d]);e.select({chain:f[l].chain}).eachResidue(function(c){c.full().setSS(n?n[c.num()-1]:"")})}pv_viewer.cartoon(k,e,{color:pv.color.uniform("white")})}}else if(0<g("#ngl:visible",currentWin.document).length)if(e)this.each(function(){var c=g(this).data("templateData");if(c)for(var e=c.struc_id,f="none"==d,k=0;k<c.keyseq_chain_name.length;k++){var l=c.keyseq_chain_name[k],
m=c.templates[0].trg_offset;m||(m=1);var n=c.keyseq_annotation[l][d+"_string"];n||(f=!0);for(comp in ngl_stage.compList)if(ngl_stage.compList[comp].name==e){ngl_stage.compList[comp].structure.eachResidue(function(c){c.chainname==l&&(c.sstruc=f?"":n[c.resno-m].toLowerCase())});break}}});else for(l=0;l<f.length;l++)if(f[l].selected){ngl_stage.eachRepresentation(function(c){if(c.name&&!c.name.match(/(ligands|dna|over)/)){var d=c.name;for(comp in ngl_stage.compList)ngl_stage.compList[comp].name==d&&ngl_stage.compList[comp].removeRepresentation(c)}});
if("none"==d)for(comp in ngl_stage.compList)ngl_stage.compList[comp].name==f[l].struc_id&&ngl_stage.compList[comp].structure.eachResidue(function(c){c.sstruc=""});else if(f[l].targets)for(m=0;m<f[l].targets.length;m++)for(q=f[l].targets[m],t=0;t<q.chain.length;t++)for(comp in(n=q.annotation[q.chain[t]][d+"_string"])||(n=q.annotation[q.chain[t]][d]),ngl_stage.compList){if(ngl_stage.compList[comp].name==f[l].struc_id){ngl_stage.compList[comp].structure.eachResidue(function(c){c.chainname==q.chain[t]&&
(c.sstruc=n[c.resno-1].toLowerCase())});break}}else for(comp in n=f[l].annotation[d+"_string"]?f[l].annotation[d+"_string"]:f[l].annotation[d],ngl_stage.compList)if(ngl_stage.compList[comp].name==f[l].struc_id){ngl_stage.compList[comp].structure.eachResidue(function(c){c.chainname==f[l].chain&&(c.sstruc=n[c.resno-1].toLowerCase())});break}k=f[l].struc_id;for(comp in ngl_stage.compList)ngl_stage.compList[comp].name==k&&(console.log("re-add representation"),ngl_stage.compList[comp].addRepresentation("cartoon",
{name:k,sele:"not :_ and not nucleic and not :-",smoothSheet:!0,aspectRatio:6,roughness:1}))}changeRep(g.cookie("defaultRepr"));da();return c},targetMismatch:function(c){jQuery.cookie("targetMismatch",c.match,{expires:365,path:"/"});return this.each(function(){V(g.cookie("colourScheme"),g(this))})},viewerInitialised:function(c){da();0<g("#pv:visible",currentWin.document).length&&pv_viewer.fitParent()},resizeToParent:function(c,d){d=c?c.redrawAnnotation:!0;return this.each(function(){var c=g(this);
if(c.is(":visible")&&c.data("templateData")){var f=g(this).find("tr td").first(),l=f.find("span").first()[0],k=c.width()-f.width(),m=c.parent().closest("table").parent();m=m.width()-(c.offset().left-m.offset().left)-k;k=f.text().length;l=Math.floor(m/l.getBoundingClientRect().width);c.data("options").textOnly&&(l=Math.floor(m/(f.width()/f.text().length)));l-=l%5;1>l&&(l=5);f=0<c.find("tr:hidden").length;m=c.data("templateData").chaingroups;l>k&&1<c.find("tr[keyseqchain]").length||l<k?(c.attr("cols_cookie")&&
g.cookie(c.attr("cols_cookie"),l,{expires:365,path:"/"}),L(c,null,{cols:l}),d&&W(c),f&&Y.toggleIdenticalSeqs.call(c,{chaingroups:m})):(d&&W(c),g("#"+c.attr("id")+"_features").css("top",c.position().top))}})},toggleEditMode:function(c){g(this).attr("id").substring("8");(U=c&&null!=c.edit?c.edit:!U)?(g("a[id^=gapEdit_]").css("opacity",1),g(".selectResidue").removeClass("selectResidue"),null==K&&(K={seqno:1,seqidx:0}),g(this).find("tr[seqno="+K.seqno+"]").find("span").eq(K.seqidx).addClass("cursor")):
(g("a[id^=gapEdit_]").css("opacity",.6),g(".cursor").removeClass("cursor"))},removeGappedColumns:function(c){c=g(this).data("templateData").templates;var d=c[0].trg_seq;for(var e=c[0].tpl_seq,f="",l="",k=0;k<d.length;k++)if("-"!=d.charAt(k)||"-"!=e.charAt(k))f+=d.charAt(k),l+=e.charAt(k);d=[f,l];c[0].trg_seq=d[0];c[0].tpl_seq=d[1];L(g(this))}},qa={},Ia="rgba(238,51,17,.5)",va="rgba(17,119,238,.5)",ca="rgba(17,204,17,.5)",Fa="rgba(255,102,0,.5)",Ga="rgba(17,187,187,.5)",Ha="rgba(238,119,119,.5)",ua=
"rgba(204,68,204,.5)",Ea="rgba(204,204,0,.5)",O={A:{name:"Alanine",triplet:"ALA",hydropathy:.7,mw:.11},C:{name:"Cysteine",triplet:"CYS",hydropathy:.78,mw:.35},D:{name:"Aspartate",triplet:"ASP",hydropathy:.11,mw:.45},E:{name:"Glutamate",triplet:"GLU",hydropathy:.11,mw:.56},F:{name:"Phenylalanine",triplet:"PHE",hydropathy:.81,mw:.7},G:{name:"Glycine",triplet:"GLY",hydropathy:.46,mw:0},H:{name:"Histidine",triplet:"HIS",hydropathy:.14,mw:.62},I:{name:"Isoleucine",triplet:"ILE",hydropathy:1,mw:.43},K:{name:"Lysine",
triplet:"LYS",hydropathy:.07,mw:.55},L:{name:"Leucine",triplet:"LEU",hydropathy:.92,mw:.43},M:{name:"Methionine",triplet:"MET",hydropathy:.71,mw:.57},N:{name:"Asparagine",triplet:"ASN",hydropathy:.11,mw:.44},P:{name:"Proline",triplet:"PRO",hydropathy:.32,mw:.31},Q:{name:"Glutamine",triplet:"GLN",hydropathy:.11,mw:.55},R:{name:"Arginine",triplet:"ARG",hydropathy:0,mw:.77},S:{name:"Serine",triplet:"SER",hydropathy:.41,mw:.23},T:{name:"Threonine",triplet:"THR",hydropathy:.42,mw:.34},V:{name:"Valine",
triplet:"VAL",hydropathy:.97,mw:.32},W:{name:"Tryptophan",triplet:"TRP",hydropathy:.4,mw:1},Y:{name:"Tyrosine",triplet:"TYR",hydropathy:.36,mw:.82},B:{name:"Aspartate or Asparagine",triplet:"ASX"},Z:{name:"Glutamate or Glutamine",triplet:"GLX"},J:{name:"Leucine or Isoleucine",triplet:"XLE"},X:{name:"Unknown",triplet:"UNC"},hydrophobic:"LIFWVM",polar:"RKDENQ",small:"TDN",large:"WYRFH",aliphatic:"ILV",charged:"HKRED",positive:"HKR",negative:"ED",tiny:"AGS",aromatic:"FYWH",proline:"P",serThr:"ST"};g.fn.alignment=
function(c){if(Y[c])return Y[c].apply(this,Array.prototype.slice.call(arguments,1));if("object"!==typeof c&&c)g.error("Method "+c+" does not exist on alignment.min.js");else return Y.init.apply(this,arguments)}})(jQuery);Object.keys||(Object.keys=function(g){var C=[],S;for(S in g)g.hasOwnProperty(S)&&C.push(S);return C});$(document).on("click",".alignmentOptions input[name=csRadioGroup]",function(){$(".alignTbl").alignment("colourAlignment",{col:$(this).val()})});
$("body").on("mousedown",function(g){$("a[id^=options_]").each(function(){$(this).is(g.target)||0!==$(this).has(g.target).length||0!==$(".popover").has(g.target).length||((($(this).popover("hide").data("bs.popover")||{}).inState||{}).click=!1)})});
$("body").on("highlightResidue",function(g,C){"alignment"!=C.src&&($(".selectResidue").removeClass("selectResidue"),"template"==C.struc_id?$('.alignTbl tr[chain="'+C.chain+'"]:visible span[s='+C.resno+"]").addClass("selectResidue"):a=$(".alignTbl tr[tpl_id^="+C.struc_id+']:visible, .alignTbl tr[struc_id="'+C.struc_id+'"]:visible ').filter('[chain="'+C.chain+'"],[keyseqchain="'+C.chain+'"]').find("span[s="+C.resno+"]").addClass("selectResidue"))});
$("a[id^=options_],button[id^=options_]").css("visibility","visible").click(function(){$("#alignmentOptions").show();$("#currentAlignmentIndex").val($(this).attr("id").substring(8))}).popover({html:!0,placement:"auto",content:$("#alignmentOptions"),container:"body"});

var all_ligands={redrawAll:function(){}},plip_bonds={refreshAll:function(){}},pv_viewer=pv.Viewer(document.getElementById("pv"),{width:300,height:300,antialias:!0,quality:"medium",outline:!0,fog:!0});
function showViewer(a){"2d"!=a&&jQuery.cookie("defaultViewer",a,{expires:365,path:"/"});$("#viewerLbl").text(a);"PV"==a?($("#viewPVLbl").html("&#10004;"),$("#viewNGLLbl,#view2dLbl").html("&nbsp;"),$("#ngl,.notPV,#2d").hide(),$("#pv,.notNGL").show(),showPV()):"NGL"==a&&($("#viewNGLLbl").html("&#10004;"),$("#viewPVLbl,#view2dLbl").html("&nbsp;"),$("#pv,.notNGL,#2d").hide(),$("#ngl,.notPV").show(),showNGL())}
function showPV(){null!=pv_viewer&&0<pv_viewer.all().length?changeRep($.cookie("defaultRepr")):pv.io.fetchPdb(structureURL,function(a){mol.assignHelixSheet(a);switch($.cookie("defaultRepr")){case "trace":pv_viewer.trace(structureId,a);break;case "lines":pv_viewer.lines(structureId,a);break;case "tube":pv_viewer.tube(structureId,a);break;default:pv_viewer.cartoon(structureId,a)}pv_viewer.lines(structureId+".ligands_lines",a.select({chain:"_"}));pv_viewer.hide(structureId+".ligands_lines");lig=a.select({chain:"_"});
a=a.select({chain:"_"});40<a.residueCount()?pv_viewer.lines(structureId+".ligands",a):pv_viewer.ballsAndSticks(structureId+".ligands",a);pv_viewer.autoZoom();pv_viewer.options("animateTime",1500);updatecols()})}function updatecols(){$(".alignTbl").first().alignment("viewerInitialised")}
function showNGL(a){null==ngl_stage&&(ngl_stage=getNGL());0<ngl_stage.getComponentsByName(structureId).list.length?changeRep($.cookie("defaultRepr")):(ngl_stage.loadFile(structureURL).then(function(b){setupNGLRepresentations(b,structureId,!0,["tube","base"],a)}),ngl_stage.mouseControls.remove("drag-ctrl+shift+right"),ngl_stage.mouseControls.remove("drag-ctrl+shift+left"))}
$("#alignmentHolder").load("js/alignment.html",function(){$("#alignTbl1").alignment(data);$("#viewerWrapper").height($("#viewerWrapper").width());pv_viewer&&showViewer("PV")});$("#viewerOptions").load("js/viewer.html");$(window).resize(function(){$("#viewerWrapper").height($("#viewerWrapper").width());pv_viewer.fitParent();null!=ngl_stage&&ngl_stage.handleResize();clearTimeout(this.id);this.id=setTimeout(function(){$(".alignTbl").alignment("resizeToParent")},400)});